<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheerpJ JVM Container</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CheerpJ 4.2 Loader -->
    <script src="https://cjrtnc.leaningtech.com/4.2/loader.js" onerror="window.cheerpjLoadError = true"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap');
        
        body { background: #000; font-family: 'JetBrains Mono', monospace; color: #ccc; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        #console { height: 100%; overflow-y: auto; padding-bottom: 20px; font-size: 13px; }
        .log-line { padding: 1px 16px; border-left: 2px solid transparent; white-space: pre-wrap; word-break: break-all; }
        
        .log-stdout { color: #ccc; }
        .log-stderr { color: #ef4444; } /* Red */
        .log-sys { color: #3b82f6; }    /* Blue */
        .log-warn { color: #eab308; }   /* Yellow */
        .log-input { color: #10b981; font-weight: bold; } /* Green */

        #cheerpjDisplay {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
            background: #000;
        }
        
        #display-container {
            background: #111;
            display: none; /* Hidden until run */
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-bottom: 1px solid #333;
        }

        .tab-active { background-color: #222; color: #fff; border-bottom: 2px solid #3b82f6; }
        .tab-inactive { color: #666; cursor: pointer; }
        .tab-inactive:hover { color: #ccc; background-color: #151515; }
        
        /* Editor Modal */
        #editor-overlay {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
        }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="flex flex-col h-screen select-none">

    <!-- Status Bar & Controls -->
    <div class="bg-[#111] border-b border-[#333] h-14 flex items-center justify-between px-4 z-20 gap-4">
        
        <!-- Left: Status Indicators -->
        <div class="flex items-center gap-4 flex-shrink-0">
            <div class="flex items-center gap-2">
                <div id="led" class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_8px_#ef4444]"></div>
                <span id="status-text" class="text-xs font-bold text-zinc-500">OFFLINE</span>
            </div>
            <div class="h-6 w-px bg-[#333]"></div>
            <div class="flex flex-col">
                <div class="text-[10px] text-zinc-500">CPU: <span class="text-zinc-300">AUTO</span></div>
                <div class="text-[10px] text-zinc-500">FS: <span class="text-blue-400">/files/ (Persistent)</span></div>
            </div>
        </div>

        <!-- Right: Controls -->
        <div class="flex-1 flex items-center justify-end gap-3">
             <!-- Boot Args -->
            <div class="hidden lg:flex items-center bg-[#1a1a1a] rounded px-2 py-1 border border-[#333]">
                <span class="text-[10px] text-zinc-500 mr-2">ARGS:</span>
                <input id="boot-args" type="text" value="--nogui" class="bg-transparent border-none outline-none text-[10px] text-zinc-300 w-24" placeholder="-flag">
            </div>

            <!-- Upload (Hidden Input) -->
            <input type="file" id="file-upload" accept=".jar" class="hidden" />
            
            <!-- Action Buttons -->
            <div class="flex items-center bg-[#222] rounded-lg p-1 border border-[#333]">
                <button id="btn-run" onclick="runSequence()" class="flex items-center gap-1 px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="play" class="w-3 h-3 fill-current"></i> RUN
                </button>
                <div class="w-px h-4 bg-[#444] mx-1"></div>
                <button id="btn-stop" onclick="stopSystem()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-red-900/50 text-red-400 hover:text-red-300 text-[10px] font-bold transition-colors" disabled>
                    <i data-lucide="square" class="w-3 h-3 fill-current"></i> STOP
                </button>
                <div class="w-px h-4 bg-[#444] mx-1"></div>
                <button id="btn-restart" onclick="restartSystem()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-[#333] text-zinc-400 hover:text-white text-[10px] font-bold transition-colors" disabled>
                    <i data-lucide="rotate-cw" class="w-3 h-3"></i> RESTART
                </button>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="flex-1 flex relative overflow-hidden">
        
        <!-- Sidebar: File Manager -->
        <div class="w-72 bg-[#0a0a0a] border-r border-[#333] flex flex-col hidden md:flex">
            <!-- Tabs -->
            <div class="flex border-b border-[#333]">
                <button onclick="switchTab('ram')" id="tab-ram" class="flex-1 py-2 text-[10px] font-bold text-center tab-active transition-colors">
                    JAR (Upload)
                </button>
                <button onclick="switchTab('disk')" id="tab-disk" class="flex-1 py-2 text-[10px] font-bold text-center tab-inactive transition-colors">
                    Config (/files/)
                </button>
            </div>

            <!-- Toolbar -->
            <div class="p-2 border-b border-[#333] flex gap-2 justify-between bg-[#111]">
                <button onclick="triggerUpload()" class="flex-1 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 text-[10px] py-1 rounded border border-blue-600/30 font-bold">
                    + Upload JAR
                </button>
                <button onclick="addConfigFile()" class="flex-1 bg-zinc-700/20 hover:bg-zinc-700/40 text-zinc-400 text-[10px] py-1 rounded border border-zinc-600/30 font-bold" title="Create eula.txt / server.properties">
                    + Config
                </button>
            </div>

            <!-- File List -->
            <div id="file-list-container" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Content injected via JS -->
            </div>
            
            <!-- Disk Info Footer -->
            <div class="p-2 border-t border-[#333] bg-[#050505] text-[10px] text-zinc-600">
                <div id="fs-info">RAM: Executable Storage</div>
            </div>
        </div>

        <!-- Main Content: Display & Terminal -->
        <div class="flex-1 bg-black flex flex-col min-w-0 relative">
            
            <!-- GUI Display (Hidden by default) -->
            <div id="display-container" class="relative">
                <div class="absolute top-2 right-2 flex gap-2 z-10">
                    <span class="px-2 py-0.5 bg-black/50 text-white text-[10px] rounded backdrop-blur">CheerpJ Display</span>
                </div>
                <!-- Canvas injected here -->
            </div>

            <!-- Terminal Output -->
            <div id="console" class="flex-1 pt-2 border-t border-[#333] font-mono">
                <div class="px-4 py-2 text-zinc-500 text-xs select-text">
                    [System] Java Runtime Environment Ready.<br>
                    [System] 1. Upload .jar to RAM.<br>
                    [System] 2. Edit Configs (eula.txt) in Config tab.<br>
                    [System] 3. Click RUN to boot into /files/ (Persistent Mode).<br>
                </div>
            </div>

            <!-- Terminal Input -->
            <div class="h-10 border-t border-[#333] bg-[#0a0a0a] flex items-center px-4 gap-2">
                <span class="text-emerald-500 font-bold">></span>
                <input id="term-input" type="text" class="bg-transparent border-none outline-none flex-1 text-sm text-zinc-300 font-mono" placeholder="Command input..." disabled onkeydown="handleInput(event)">
            </div>

            <!-- FILE EDITOR MODAL -->
            <div id="editor-overlay" class="absolute inset-0 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-[#1a1a1a] w-full max-w-2xl h-[80%] rounded-lg border border-[#333] shadow-2xl flex flex-col">
                    <div class="h-10 border-b border-[#333] flex items-center justify-between px-4 bg-[#222] rounded-t-lg">
                        <span id="editor-title" class="text-xs font-bold text-zinc-300">Editing: file.txt</span>
                        <button onclick="closeEditor()" class="text-zinc-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    <textarea id="editor-content" class="flex-1 bg-[#0f0f0f] text-zinc-300 p-4 font-mono text-xs resize-none focus:outline-none" spellcheck="false"></textarea>
                    <div class="h-12 border-t border-[#333] flex items-center justify-end px-4 gap-2 bg-[#222] rounded-b-lg">
                        <button onclick="closeEditor()" class="px-3 py-1.5 text-xs text-zinc-400 hover:text-white">Cancel</button>
                        <button onclick="saveEditorContent()" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded">Save (Queue)</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. CONSOLE PROXY (Safe Logging) ---
        (function() {
            const originalLog = console.log;
            const originalErr = console.error;
            const originalWarn = console.warn;
            const consoleDiv = document.getElementById('console');

            function printToUI(msg, type) {
                const line = document.createElement('div');
                line.className = `log-line log-${type}`;
                const time = new Date().toLocaleTimeString('en-GB', { hour12: false });
                let text = msg;
                if (typeof msg === 'object') { try { text = JSON.stringify(msg); } catch(e) { text = '[Object]'; } }
                line.innerHTML = `<span class="opacity-30 mr-2 select-none">[${time}]</span>${text}`;
                consoleDiv.appendChild(line);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }

            console.log = function(...args) { originalLog.apply(console, args); printToUI(args.join(' '), 'stdout'); };
            console.error = function(...args) { originalErr.apply(console, args); printToUI(args.join(' '), 'stderr'); };
            console.warn = function(...args) { originalWarn.apply(console, args); printToUI(args.join(' '), 'warn'); };
            window.sysLog = function(msg) { printToUI(msg, 'sys'); }
        })();

        // --- 2. STATE & UI ---
        lucide.createIcons();

        let systemState = {
            power: false,
            jvmLoaded: false,
            jarName: null,
            jarData: null,
            currentTab: 'ram',
            filesRAM: [],
            // These files will be written to /files/ AFTER init
            filesDISK: [
                {name: 'eula.txt', content: 'eula=true', size: 9, type: 'text'},
                {name: 'server.properties', content: 'server-port=25565\nonline-mode=false', size: 35, type: 'text'}
            ] 
        };
        
        function switchTab(tab) {
            systemState.currentTab = tab;
            document.getElementById('tab-ram').className = `flex-1 py-2 text-[10px] font-bold text-center transition-colors ${tab === 'ram' ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('tab-disk').className = `flex-1 py-2 text-[10px] font-bold text-center transition-colors ${tab === 'disk' ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('fs-info').innerText = tab === 'ram' ? "RAM: Executable Storage" : "DISK: Persistent Config Queue";
            renderFileList();
        }

        function renderFileList() {
            const container = document.getElementById('file-list-container');
            container.innerHTML = '';
            const files = systemState.currentTab === 'ram' ? systemState.filesRAM : systemState.filesDISK;

            if (files.length === 0) {
                container.innerHTML = `<div class="text-zinc-700 text-xs italic p-4 text-center">Empty</div>`;
                return;
            }

            files.forEach(f => {
                const el = document.createElement('div');
                el.className = "flex items-center gap-2 text-xs p-1.5 hover:bg-[#222] rounded cursor-pointer group select-none";
                el.onclick = () => openEditor(f);
                el.innerHTML = `
                    <i data-lucide="${f.name.endsWith('.jar') ? 'file-code' : 'file-text'}" class="w-3 h-3 text-zinc-500"></i>
                    <span class="text-zinc-300 flex-1 truncate">${f.name}</span>
                    <span class="text-[9px] text-zinc-600">${f.size ? (f.size < 1024 ? f.size+'B' : (f.size/1024).toFixed(0)+'kb') : ''}</span>
                `;
                container.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- 3. EDITOR LOGIC ---
        let currentEditingFile = null;

        function openEditor(file) {
            if (systemState.currentTab === 'ram' && file.name.endsWith('.jar')) {
                window.sysLog("Cannot edit binary JAR files.");
                return;
            }
            if (file.name.endsWith('.txt') || file.name.endsWith('.properties') || file.name.endsWith('.json') || file.name.endsWith('.yml')) {
                currentEditingFile = file;
                const modal = document.getElementById('editor-overlay');
                document.getElementById('editor-title').innerText = `Editing: ${file.name}`;
                document.getElementById('editor-content').value = file.content || "";
                modal.classList.remove('hidden');
            } else {
                window.sysLog(`Cannot edit ${file.name}.`);
            }
        }

        function closeEditor() {
            document.getElementById('editor-overlay').classList.add('hidden');
            currentEditingFile = null;
        }

        function saveEditorContent() {
            if (!currentEditingFile) return;
            const content = document.getElementById('editor-content').value;
            currentEditingFile.content = content;
            currentEditingFile.size = content.length;
            
            // IF JVM is already online, write immediately.
            // IF JVM is offline, just save to array (Queue) and it will write on boot.
            if (systemState.jvmLoaded) {
                const path = "/files/" + currentEditingFile.name;
                const writeFunc = typeof cheerpOSAddStringFile === 'function' ? cheerpOSAddStringFile : null;
                if (writeFunc) {
                    try {
                        writeFunc(path, content);
                        window.sysLog(`System: Hot-swapped ${path} (Saved to DISK).`);
                    } catch(e) { window.sysLog("Write Error: " + e.message); }
                }
            } else {
                window.sysLog(`System: Queued ${currentEditingFile.name} for write on Boot.`);
            }
            
            closeEditor();
            renderFileList();
        }

        function addConfigFile() {
            const name = prompt("Enter filename (e.g. eula.txt):", "eula.txt");
            if (!name) return;
            if (systemState.filesDISK.find(f => f.name === name)) {
                window.sysLog("File already exists."); return;
            }
            const newFile = {name: name, content: "", size: 0, type: 'text'};
            systemState.filesDISK.push(newFile);
            renderFileList();
            openEditor(newFile);
        }

        // --- 4. CONTROLS & EXECUTION ---

        function handleInput(e) {
            if (e.key === 'Enter') {
                const input = e.target.value;
                if (!input.trim()) return;
                const consoleDiv = document.getElementById('console');
                const line = document.createElement('div');
                line.className = `log-line log-input`;
                line.innerText = `> ${input}`;
                consoleDiv.appendChild(line);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                e.target.value = '';
            }
        }

        async function runSequence() {
            if (systemState.power) return;
            
            if (!systemState.jarData) {
                window.sysLog("Error: No JAR loaded in RAM. Please upload one first.");
                return;
            }

            systemState.power = true;
            updateControls(true);
            
            document.getElementById('led').className = "w-3 h-3 rounded-full bg-yellow-500 shadow-[0_0_8px_#eab308]";
            document.getElementById('status-text').innerText = "BOOTING";
            document.getElementById('status-text').className = "text-xs font-bold text-yellow-500";

            // 1. INITIALIZE JVM (Mounts /files/)
            if (!systemState.jvmLoaded) {
                window.sysLog("Bios: Initializing CheerpJ 4.2 Engine...");
                window.sysLog("Bios: Mounting /files/ as Working Directory (Persistent)...");
                
                try {
                    // Set working directory to /files/ so server writes logs/worlds there
                    await cheerpjInit({ javaProperties: ["user.dir=/files/"] });
                    systemState.jvmLoaded = true;
                } catch (e) {
                    console.error("Bios Error: " + e.message);
                    stopSystem(false);
                    return;
                }
            }

            // 2. FLUSH CONFIG QUEUE TO DISK
            window.sysLog("Bios: Flushing config files to /files/...");
            const writeFunc = typeof cheerpOSAddStringFile === 'function' ? cheerpOSAddStringFile : (typeof cheerpjAddStringFile === 'function' ? cheerpjAddStringFile : null);
            
            if (writeFunc) {
                systemState.filesDISK.forEach(f => {
                    if (f.content) {
                        try {
                            // THIS IS THE FIX: We write to /files/ AFTER init
                            writeFunc("/files/" + f.name, f.content);
                            // Also write to /str/ just in case server checks there
                            try { writeFunc("/str/" + f.name, f.content); } catch(e){}
                        } catch(e) {
                            window.sysLog(`Failed to write ${f.name}: ${e.message}`);
                        }
                    }
                });
            }

            document.getElementById('led').className = "w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]";
            document.getElementById('status-text').innerText = "ONLINE";
            document.getElementById('status-text').className = "text-xs font-bold text-emerald-500";
            document.getElementById('term-input').disabled = false;
            document.getElementById('term-input').focus();

            await executeJar();
        }

        function stopSystem(reload = true) {
            if (reload) {
                if(confirm("Stopping the JVM requires a page reload. Continue?")) window.location.reload();
            } else {
                systemState.power = false;
                updateControls(false);
                document.getElementById('led').className = "w-3 h-3 rounded-full bg-red-500 shadow-[0_0_8px_#ef4444]";
                document.getElementById('status-text').innerText = "HALTED";
                document.getElementById('status-text').className = "text-xs font-bold text-red-500";
            }
        }

        function restartSystem() {
            if(confirm("Restarting will reload the page. Continue?")) window.location.reload();
        }

        function updateControls(isRunning) {
            const runBtn = document.getElementById('btn-run');
            const stopBtn = document.getElementById('btn-stop');
            const restartBtn = document.getElementById('btn-restart');
            runBtn.disabled = isRunning;
            stopBtn.disabled = !isRunning;
            restartBtn.disabled = !isRunning;
            if (isRunning) {
                runBtn.classList.add('opacity-50', 'cursor-not-allowed');
                stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                restartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function triggerUpload() { document.getElementById('file-upload').click(); }

        document.getElementById('file-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            window.sysLog(`System: Reading ${file.name}...`);
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    systemState.jarData = new Uint8Array(evt.target.result);
                    systemState.jarName = file.name;
                    systemState.filesRAM.push({ name: file.name, size: file.size });
                    renderFileList();
                    window.sysLog(`System: ${file.name} buffered in memory.`);
                } catch(err) {
                    console.error("Read Error: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        async function executeJar() {
            const display = document.getElementById('display-container');
            display.style.display = 'flex';
            display.style.height = '60%'; 

            const rawArgs = document.getElementById('boot-args').value;
            const args = rawArgs.split(' ').filter(a => a.length > 0);
            
            // Write JAR to RAM (/str/) for execution
            const vfsPath = "/str/" + systemState.jarName;
            window.sysLog(`System: Mounting Executable to ${vfsPath}...`);

            try {
                const writeFunc = typeof cheerpOSAddStringFile === 'function' ? cheerpOSAddStringFile : (typeof cheerpjAddStringFile === 'function' ? cheerpjAddStringFile : null);
                if (writeFunc) {
                    writeFunc(vfsPath, systemState.jarData);
                } else {
                    throw new Error("Filesystem API missing");
                }

                window.sysLog(`System: Executing JAR...`);
                window.sysLog(`Args: ${args.join(' ')}`);
                console.log("----------------------------------------");

                cheerpjCreateDisplay(800, 600);
                setTimeout(() => {
                    const canvas = document.getElementById('cheerpjDisplay');
                    if(canvas) display.appendChild(canvas);
                }, 100);

                await cheerpjRunJar(vfsPath, args);

            } catch (e) {
                console.error(`Runtime Exception: ${e.message}`);
            }
        }
        
        renderFileList();
    </script>
</body>
</html>
